{% comment %} AÑADIR BOOTSTRAP {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous">
</script>

{% comment %} BORRADO DE COMENTARIO VIA AJAX {% endcomment %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const alertContainer = document.getElementById('alert-container');

        // Delegación de eventos para eliminar comentario
        document.querySelectorAll('.delete-comment-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                event.preventDefault();
                const form = event.target.closest('form');
                const commentId = form.dataset.commentId;
                const url = form.dataset.url;

                if (!confirm("¿Seguro que quieres eliminar este comentario?")) return;

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken"),
                            "X-Requested-With": "XMLHttpRequest"
                        },
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Eliminar visualmente el comentario
                        const commentElement = document.getElementById(`comment-${commentId}`);
                        if (commentElement) commentElement.remove();

                        showAlert("Comentario eliminado correctamente ✅", "success");
                    } else {
                        showAlert(data.error || "No se pudo eliminar el comentario.", "danger");
                    }
                } catch (error) {
                    showAlert("Error de conexión con el servidor.", "danger");
                }
            });
        });

        function showAlert(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0 show`;
            toast.role = 'alert';
            toast.ariaLive = 'assertive';
            toast.ariaAtomic = 'true';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Eliminar el toast después de 3 segundos
            setTimeout(() => {
                const toastInstance = bootstrap.Toast.getOrCreateInstance(toast);
                toastInstance.hide();
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- Obtener el CSRF token ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- Evitar que el collapse se cierre cuando se elimine un comentario---
        const collapse = form.closest('.collapse');
        const bsCollapse = bootstrap.Collapse.getInstance(collapse);
        if (bsCollapse) {
            bsCollapse._isTransitioning = false; // Evita animación forzada
        }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".btn-like").forEach(button => {
            button.addEventListener("click", function () {
                const articleId = this.dataset.articleId;
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch("{% url 'article:toggle_like' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken,
                        "X-Requested-With": "XMLHttpRequest",
                    },
                    body: new URLSearchParams({ article_id: articleId })
                })
                .then(response => response.json())
                .then(data => {
                    const likeCount = document.getElementById(`like-count-${articleId}`);
                    likeCount.textContent = data.total_likes;
                    if (data.liked) {
                        button.classList.add("btn-danger");
                        button.classList.remove("btn-outline-danger");
                    } else {
                        button.classList.add("btn-outline-danger");
                        button.classList.remove("btn-danger");
                    }
                });
            });
        });
    });
</script>
